<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zzb.extra.entity">
    <!-- INSBCommission //任务99关联的mini营销活动代码发布cm后台-->
    <select id="INSBCommission_insert" parameterType="com.zzb.extra.entity.INSBCommission" resultType="int">
		insert into INSBCommission
		(id,operator,createtime,modifytime,noti,taskid,agreementid,commissiontype,commissionrateid,counts,status,providercode,commissionflag,commissionratioid,channelid)
		values
		(#{id},#{operator},#{createtime},#{modifytime},#{noti},#{taskid},#{agreementid},#{commissiontype},#{commissionrateid},#{counts},#{status},#{providercode},#{commissionFlag},#{commissionRatioId},#{channelId})
	</select>
    <select id="queryCommissionList" parameterType="Map" resultType="com.zzb.extra.entity.INSBCommission">
       	select * from INSBCommission
        <where>
            <if test="taskid != null">
                and taskid = #{taskid}
            </if>
            <if test="commissionrateid != null">
                and commissionrateid = #{commissionrateid}
            </if>
            <if test="counts != null">
                and counts = #{counts}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="providercode != null and providercode !='' ">
                and providercode = #{providercode}
            </if>
            <if test="commissionFlag != null and commissionFlag != '' ">
                and commissionflag = #{commissionFlag}
            </if>
        </where>
        ORDER BY
        <if test="sort != null and order != null">
            ${sort} ${order}
        </if>
        <if test="sort == null">
            createtime desc
        </if>
        <if test="offset != null and limit != null">
            LIMIT #{offset},#{limit}
        </if>
    </select>
    <select id="queryCommissions" parameterType="Map" resultType="com.zzb.extra.entity.INSBCommission">
       	select * from INSBCommission where taskid=#{taskid} and agreementid=#{agreementid}
        <if test="commissionFlag != null and commissionFlag != '' ">
            and commissionflag = #{commissionFlag}
        </if>
    </select>
    <select id="queryLockedCommissionCountByTaskId" parameterType="String" resultType="int">
       	select count(1) from INSBCommission where taskid=#{taskid} and status != '0'
    </select>
    <select id="queryCompletedCommissionCountByTaskId" parameterType="String" resultType="int">
       	select count(1) from INSBCommission where taskid=#{taskid} and status='2'
    </select>
    <select id="queryCountByRateId" parameterType="Map" resultType="int">
       	select count(1) from INSBCommission
        <where>
        <if test="commissionrateid != null ">
            and commissionrateid = #{commissionrateid}
        </if>
        <if test="commissionratioid != null and commissionratioid !='' ">
            and commissionratioid = #{commissionratioid}
        </if>
        </where>
    </select>
    <select id="INSBCommission_selectById" parameterType="String" resultType="com.zzb.extra.entity.INSBCommission">
		select * from INSBCommission where id = #{id}
	</select>
    <select id="INSBCommission_deleteById" parameterType="String">
		delete from INSBCommission where id = #{id}
	</select>
    <select id="INSBCommission_deleteByTask" parameterType="String">
        delete from INSBCommission where taskid=#{taskid} and agreementid=#{agreementid}
        <if test="commissionFlag != null and  commissionFlag != '' ">
            and commissionflag = #{commissionFlag}
        </if>
    </select>
    <select id="INSBCommission_lockByTaskId" parameterType="String" resultType="int">
        update INSBCommission  set modifytime = NOW(),status ='1' where taskid = #{taskid} and status='0'
    </select>
    <select id="INSBCommission_completeByTaskId" parameterType="String" resultType="int">
        update INSBCommission  set modifytime = NOW(),status ='2' where taskid = #{taskid} and status='1'
    </select>
    <select id="INSBCommission_updateById" parameterType="com.zzb.extra.entity.INSBCommission" resultType="int">
		update INSBCommission  set modifytime = #{modifytime},commissionrateid = #{commissionrateid},counts = #{counts},status = #{status} where id = #{id}
	</select>
    <select id="queryCommissionListCount" parameterType="Map" resultType="Long">
       	select count(1) from INSBCommission
        <where>
            <if test="taskid != null">
                and taskid = #{taskid}
            </if>
            <if test="commissionrateid != null ">
                and commissionrateid = #{commissionrateid}
            </if>
            <if test="commissionratioid != null and commissionratioid !='' ">
                and commissionratioid = #{commissionratioid}
            </if>
            <if test="counts != null">
                and counts = #{counts}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="providercode != null and providercode !='' ">
                and providercode = #{providercode}
            </if>
            <if test="commissionFlag != null and commissionFlag != '' ">
                and commissionflag = #{commissionFlag}
            </if>
        </where>
    </select>
    <select id="INSBCommission_selectOne" parameterType="Map" resultType="com.zzb.extra.entity.INSBCommission">
       	select * from INSBCommission
        <where>
            <if test="taskid != null">
                and taskid = #{taskid}
            </if>
            <if test="commissionrateid != null">
                and commissionrateid = #{commissionrateid}
            </if>
            <if test="counts != null">
                and counts = #{counts}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="providercode != null and providercode !='' ">
                and providercode = #{providercode}
            </if>
            <if test="commissionFlag != null and commissionFlag != '' ">
                and commissionflag = #{commissionFlag}
            </if>
        </where>
        LIMIT 2
    </select>

    <select id="INSBCommission_queryCommissionInfo" parameterType="Map" resultType="Map">
        select  a.taskid,a.providercode as providerid ,a.channelid,a.commissionflag,a.commissiontype
                ,case when a.commissiontype ='01' then '商业险' else '交强险' end as commissiontypecname
                ,concat(b.id,'&amp;',a.commissionratioid) as ruleid
                ,b.remark as rateremark,b.reminder,b.rate,ifnull(c.calculatetype,'3') as calculatetype
                ,(case when c.calculatetype = '1' then '加'
                       when c.calculatetype = '2' then '减'
                       when c.calculatetype = '3' then '乘'
                       when c.calculatetype = '4' then '除'
                      else '乘' end) as calculatetypecname
                ,ifnull(c.ratio,1) as ratio,c.remark as ratioremark,ifnull(chnrate.taxrate,1) as taxrate
                ,a.counts
        from insbcommission a
        INNER JOIN insbcommissionrate b on a.commissionrateid = b.id and b.productcode = 'channel'
        LEFT JOIN insbcommissionratio c on a.commissionratioid = c.id
        LEFT JOIN insbchntaxrate chnrate on a.channelid = chnrate.channelid and NOW() BETWEEN chnrate.effectivetime and IFNULL(chnrate.terminaltime,'2199-12-31 23:59:59') and chnrate.`status`='1'
         <where>
            <if test="channelid != null  and channelid != ''">
                and a.channelid = #{channelid}
            </if>
            <if test="taskid != null  and taskid != ''">
                and a.taskid = #{taskid}
            </if>
            <if test="providerid != null  and providerid != ''">
                and a.providercode = #{providerid}
            </if>
            <if test="commissionflag != null  and commissionflag != ''">
                and a.commissionflag = #{commissionflag}
            </if>
            <if test="commissiontype != null  and commissiontype != ''">
                and a.commissiontype = #{commissiontype}
            </if>
             <if test="begindate != null  and begindate != ''">
                 and date_format(a.createtime,'%Y-%m-%d') &gt;= #{begindate}
             </if>
             <if test="enddate != null  and enddate != ''">
                 and date_format(a.createtime,'%Y-%m-%d') &lt;= #{enddate}
             </if>
         </where>
        ORDER BY
        <if test="sort != null and order != null">
            ${sort} ${order}
        </if>
        <if test="sort == null">
            a.createtime desc
        </if>
        <if test="offset != null and limit != null">
            LIMIT #{offset},#{limit}
        </if>
    </select>

    <select id="INSBCommission_queryCommissionInfoCount" parameterType="Map" resultType="Long">
        select  count(1)
        from insbcommission a
        INNER JOIN insbcommissionrate b on a.commissionrateid = b.id and b.productcode = 'channel'
        LEFT JOIN insbcommissionratio c on a.commissionratioid = c.id
        <where>
            <if test="channelid != null  and channelid != ''">
                and a.channelid = #{channelid}
            </if>
            <if test="taskid != null  and taskid != ''">
                and a.taskid = #{taskid}
            </if>
            <if test="providerid != null  and providerid != ''">
                and a.providercode = #{providerid}
            </if>
            <if test="commissionflag != null  and commissionflag != ''">
                and a.commissionflag = #{commissionflag}
            </if>
            <if test="commissiontype != null  and commissiontype != ''">
                and a.commissiontype = #{commissiontype}
            </if>
            <if test="begindate != null  and begindate != ''">
                and date_format(a.createtime,'%Y-%m-%d') &gt;= #{begindate}
            </if>
            <if test="enddate != null  and enddate != ''">
                and date_format(a.createtime,'%Y-%m-%d') &lt;= #{enddate}
            </if>
        </where>
    </select>

    <select id="INSBCommission_queryCommissionInfoForBC" parameterType="Map" resultType="Map">
        select * from (
        select distinct e.channelname,h.comname,c.inscityname as insuredarea,a.taskid,d.policyno as policyno,f.carlicenseno ,d.carownername
        ,a.providercode as prvid,g.agreementname as compname,ifnull(d.insureddate,d.createtime) as insureddate,d.startdate,'商业险' as risktype,d.premium
        , case when ifnull(ratio.calculatetype,'3') = '1' then b.rate + ifnull(ratio.ratio,0)
        when ifnull(ratio.calculatetype,'3') = '2' then b.rate - ifnull(ratio.ratio,0)
        when ifnull(ratio.calculatetype,'3') = '3' then b.rate * ifnull(ratio.ratio,1)
        else b.rate/ifnull(ratio.ratio,1) end as channelrate
        , case when ifnull(ratio.calculatetype,'3') = '1' then d.premium/ifnull(chnrate.taxrate,1)*(b.rate + ifnull(ratio.ratio,0))
        when ifnull(ratio.calculatetype,'3') = '2' then d.premium/ifnull(chnrate.taxrate,1)*(b.rate - ifnull(ratio.ratio,0))
        when ifnull(ratio.calculatetype,'3') = '3' then d.premium/ifnull(chnrate.taxrate,1)*(b.rate * ifnull(ratio.ratio,1))
        else d.premium/ifnull(chnrate.taxrate,1)*(b.rate/ifnull(ratio.ratio,1)) end  as channelcommission
        ,b.id as commissionruleid,b.remark as commissionremark,b.reminder as commissionreminder
        ,ratio.id as commissionratioid
        ,case when ratio.calculatetype = '1' then '加'
        when ratio.calculatetype = '2' then '减'
        when ratio.calculatetype = '3' then '乘'
        when ratio.calculatetype = '4' then '除'
        else '乘' end as calculatetype
        ,ifnull(ratio.ratio,1) as ratio ,b.rate ,b.rate * d.premium as deptcommission
        ,ifnull(rqrp.inscorpname,rqc.inscorpname) as inscorpname,rqrp.policystarttime,rqrp.policyendtime
        ,rqo.bwcommercialclaimtimes,rqo.firstinsuretype
        ,chnrate.id as taxrateid,ifnull(chnrate.taxrate,1) as taxrate
        from insbcommission a inner JOIN insbcommissionrate b on a.commissionrateid = b.id
        INNER JOIN insbquotetotalinfo c on a.taskid = c.taskid
        INNER JOIN insbpolicyitem d on a.taskid = d.taskid and a.providercode = d.inscomcode
        INNER JOIN insbchannel e on c.purchaserchannel = e.channelinnercode
        INNER JOIN insbcarinfohis f on  a.taskid = f.taskid and a.providercode = f.inscomcode
        INNER JOIN insbagreement g on a.agreementid = g.id
        INNER JOIN inscdept h on  g.deptid = h.id
        LEFT JOIN insbcommissionratio ratio ON a.commissionratioid = ratio.id
        LEFT JOIN insbrulequeryrepeatinsured rqrp on a.taskid = rqrp.taskid and rqrp.risktype = '0'
        LEFT JOIN insbrulequeryotherinfo rqo on a.taskid = rqo.taskid
        LEFT JOIN insbrulequeryclaims rqc on a.taskid = rqc.taskid
        LEFT JOIN insbchntaxrate chnrate on a.channelid = chnrate.channelid and NOW() BETWEEN chnrate.effectivetime and IFNULL(chnrate.terminaltime,'2199-12-31 23:59:59') and chnrate.`status`='1'
        where
        e.childflag = '1'
        AND (
        e.deleteflag != 0
        OR e.deleteflag IS NULL
        )
        and c.purchaserchannel != 'nqd_minizzb2016'
        and a.commissionflag ='insured'
        and a.commissiontype='01'
        and d.risktype='0'
        and d.insuredname not like '%测试%'
        and d.carownername not like '%测试%'
        and d.policyno is not null
        <if test="channelId != null  and channelId != ''">
            and e.channelinnercode = #{channelId}
        </if>
        <if test="prvId != null  and prvId != ''">
            and a.providercode = #{prvId}
        </if>
        <if test="deptId != null  and deptId != ''">
            and g.deptid = #{deptId}
        </if>
        <if test="carLicenseNo != null  and carLicenseNo != ''">
            and f.carlicenseno = #{carLicenseNo}
        </if>
        <if test="carOwnerName != null  and carOwnerName != ''">
            and d.carownername = #{carOwnerName}
        </if>
        <if test="taskId != null  and taskId != ''">
            and a.taskid = #{taskId}
        </if>
        <if test="policyNo != null  and policyNo != ''">
            and d.policyno = #{policyNo}
        </if>
        <if test="insuredDateBegin != null  and insuredDateBegin != ''">
            and DATE_FORMAT(ifnull(d.insureddate,d.createtime),'%Y-%m-%d') &gt;=  #{insuredDateBegin}
        </if>
        <if test="insuredDateEnd != null  and insuredDateEnd != ''">
            and DATE_FORMAT(ifnull(d.insureddate,d.createtime),'%Y-%m-%d') &lt;= #{insuredDateEnd}
        </if>
        union ALL
        select distinct e.channelname,h.comname,c.inscityname as insuredarea,a.taskid,d.policyno as policyno,f.carlicenseno ,d.carownername
        ,a.providercode as prvid,g.agreementname as compname,ifnull(d.insureddate,d.createtime) as insureddate,d.startdate,'交强险' as risktype,d.premium
        , case when ifnull(ratio.calculatetype,'3') = '1' then b.rate + ifnull(ratio.ratio,0)
        when ifnull(ratio.calculatetype,'3') = '2' then b.rate - ifnull(ratio.ratio,0)
        when ifnull(ratio.calculatetype,'3') = '3' then b.rate * ifnull(ratio.ratio,1)
        else b.rate/ifnull(ratio.ratio,1) end as channelrate
        , case when ifnull(ratio.calculatetype,'3') = '1' then d.premium/ifnull(chnrate.taxrate,1)*(b.rate + ifnull(ratio.ratio,0))
        when ifnull(ratio.calculatetype,'3') = '2' then d.premium/ifnull(chnrate.taxrate,1)*(b.rate - ifnull(ratio.ratio,0))
        when ifnull(ratio.calculatetype,'3') = '3' then d.premium/ifnull(chnrate.taxrate,1)*(b.rate * ifnull(ratio.ratio,1))
        else d.premium/ifnull(chnrate.taxrate,1)*(b.rate/ifnull(ratio.ratio,1)) end  as channelcommission
        ,b.id as commissionruleid,b.remark as commissionremark,b.reminder as commissionreminder
        ,ratio.id as commissionratioid
        ,case when ratio.calculatetype = '1' then '加'
        when ratio.calculatetype = '2' then '减'
        when ratio.calculatetype = '3' then '乘'
        when ratio.calculatetype = '4' then '除'
        else '乘' end as calculatetype
        ,ifnull(ratio.ratio,1) as ratio ,b.rate ,b.rate * d.premium as deptcommission
        ,ifnull(rqrp.inscorpname,rqc.inscorpname) as inscorpname,rqrp.policystarttime,rqrp.policyendtime
        ,rqo.bwcommercialclaimtimes,rqo.firstinsuretype
        ,chnrate.id as taxrateid,ifnull(chnrate.taxrate,1) as taxrate
        from insbcommission a inner JOIN insbcommissionrate b on a.commissionrateid = b.id
        INNER JOIN insbquotetotalinfo c on a.taskid = c.taskid
        INNER JOIN insbpolicyitem d on a.taskid = d.taskid and a.providercode = d.inscomcode
        INNER JOIN insbchannel e on c.purchaserchannel = e.channelinnercode
        INNER JOIN insbcarinfohis f on  a.taskid = f.taskid and a.providercode = f.inscomcode
        INNER JOIN insbagreement g on a.agreementid = g.id
        INNER JOIN inscdept h on  g.deptid = h.id
        LEFT JOIN insbcommissionratio ratio ON a.commissionratioid = ratio.id
        LEFT JOIN insbrulequeryrepeatinsured rqrp on a.taskid = rqrp.taskid and rqrp.risktype = '1'
        LEFT JOIN insbrulequeryotherinfo rqo on a.taskid = rqo.taskid
        LEFT JOIN insbrulequeryclaims rqc on a.taskid = rqc.taskid
        LEFT JOIN insbchntaxrate chnrate on a.channelid = chnrate.channelid and NOW() BETWEEN chnrate.effectivetime and IFNULL(chnrate.terminaltime,'2199-12-31 23:59:59') and chnrate.`status`='1'
        where
        e.childflag = '1'
        AND (
        e.deleteflag != 0
        OR e.deleteflag IS NULL
        )
        and c.purchaserchannel != 'nqd_minizzb2016'
        and a.commissionflag ='insured'
        and a.commissiontype='03'
        and d.risktype='1'
        and d.insuredname not like '%测试%'
        and d.carownername not like '%测试%'
        and d.policyno is not null
        <if test="channelId != null  and channelId != ''">
            and e.channelinnercode = #{channelId}
        </if>
        <if test="prvId != null  and prvId != ''">
            and a.providercode = #{prvId}
        </if>
        <if test="deptId != null  and deptId != ''">
            and g.deptid = #{deptId}
        </if>
        <if test="carLicenseNo != null  and carLicenseNo != ''">
            and f.carlicenseno = #{carLicenseNo}
        </if>
        <if test="carOwnerName != null  and carOwnerName != ''">
            and d.carownername = #{carOwnerName}
        </if>
        <if test="taskId != null  and taskId != ''">
            and a.taskid = #{taskId}
        </if>
        <if test="policyNo != null  and policyNo != ''">
            and d.policyno = #{policyNo}
        </if>
        <if test="insuredDateBegin != null  and insuredDateBegin != ''">
            and DATE_FORMAT(ifnull(d.insureddate,d.createtime),'%Y-%m-%d') &gt;=  #{insuredDateBegin}
        </if>
        <if test="insuredDateEnd != null  and insuredDateEnd != ''">
            and DATE_FORMAT(ifnull(d.insureddate,d.createtime),'%Y-%m-%d') &lt;= #{insuredDateEnd}
        </if>
        ) as a
        ORDER BY
        <if test="sort != null and order != null">
            ${sort} ${order}
        </if>
        <if test="sort == null">
            channelname,taskid ,risktype,insureddate
        </if>
        <if test="offset != null and limit != null">
            LIMIT #{offset},#{limit}
        </if>
    </select>

    <select id="INSBCommission_queryCommissionInfoForBCCount" parameterType="Map" resultType="Long">
        select count(1) from (
        select distinct e.channelname,h.comname,c.inscityname as insuredarea,a.taskid,d.policyno as policyno,f.carlicenseno ,d.carownername
        ,a.providercode as prvid,g.agreementname as compname,ifnull(d.insureddate,d.createtime) as insureddate,d.startdate,'商业险' as risktype,d.premium
        , case when ifnull(ratio.calculatetype,'3') = '1' then b.rate + ifnull(ratio.ratio,0)
        when ifnull(ratio.calculatetype,'3') = '2' then b.rate - ifnull(ratio.ratio,0)
        when ifnull(ratio.calculatetype,'3') = '3' then b.rate * ifnull(ratio.ratio,1)
        else b.rate/ifnull(ratio.ratio,1) end as channelrate
        , case when ifnull(ratio.calculatetype,'3') = '1' then d.premium/ifnull(chnrate.taxrate,1)*(b.rate + ifnull(ratio.ratio,0))
        when ifnull(ratio.calculatetype,'3') = '2' then d.premium/ifnull(chnrate.taxrate,1)*(b.rate - ifnull(ratio.ratio,0))
        when ifnull(ratio.calculatetype,'3') = '3' then d.premium/ifnull(chnrate.taxrate,1)*(b.rate * ifnull(ratio.ratio,1))
        else d.premium/ifnull(chnrate.taxrate,1)*(b.rate/ifnull(ratio.ratio,1)) end  as channelcommission
        ,b.id as commissionruleid,b.remark as commissionremark,b.reminder as commissionreminder
        ,ratio.id as commissionratioid
        ,case when ratio.calculatetype = '1' then '加'
        when ratio.calculatetype = '2' then '减'
        when ratio.calculatetype = '3' then '乘'
        when ratio.calculatetype = '4' then '除'
        else '乘' end as calculatetype
        ,ifnull(ratio.ratio,1) as ratio ,b.rate ,b.rate * d.premium as deptcommission
        ,ifnull(rqrp.inscorpname,rqc.inscorpname) as inscorpname,rqrp.policystarttime,rqrp.policyendtime
        ,rqo.bwcommercialclaimtimes,rqo.firstinsuretype
        ,chnrate.id as taxrateid,ifnull(chnrate.taxrate,1) as taxrate
        from insbcommission a inner JOIN insbcommissionrate b on a.commissionrateid = b.id
        INNER JOIN insbquotetotalinfo c on a.taskid = c.taskid
        INNER JOIN insbpolicyitem d on a.taskid = d.taskid and a.providercode = d.inscomcode
        INNER JOIN insbchannel e on c.purchaserchannel = e.channelinnercode
        INNER JOIN insbcarinfohis f on  a.taskid = f.taskid and a.providercode = f.inscomcode
        INNER JOIN insbagreement g on a.agreementid = g.id
        INNER JOIN inscdept h on  g.deptid = h.id
        LEFT JOIN insbcommissionratio ratio ON a.commissionratioid = ratio.id
        LEFT JOIN insbrulequeryrepeatinsured rqrp on a.taskid = rqrp.taskid and rqrp.risktype = '0'
        LEFT JOIN insbrulequeryotherinfo rqo on a.taskid = rqo.taskid
        LEFT JOIN insbrulequeryclaims rqc on a.taskid = rqc.taskid
        LEFT JOIN insbchntaxrate chnrate on a.channelid = chnrate.channelid and NOW() BETWEEN chnrate.effectivetime and IFNULL(chnrate.terminaltime,'2199-12-31 23:59:59') and chnrate.`status`='1'
        where
        e.childflag = '1'
        AND (
        e.deleteflag != 0
        OR e.deleteflag IS NULL
        )
        and c.purchaserchannel != 'nqd_minizzb2016'
        and a.commissionflag ='insured'
        and a.commissiontype='01'
        and d.risktype='0'
        and d.insuredname not like '%测试%'
        and d.carownername not like '%测试%'
        and d.policyno is not null
        <if test="channelId != null  and channelId != ''">
            and e.channelinnercode = #{channelId}
        </if>
        <if test="prvId != null  and prvId != ''">
            and a.providercode = #{prvId}
        </if>
        <if test="deptId != null  and deptId != ''">
            and g.deptid = #{deptId}
        </if>
        <if test="carLicenseNo != null  and carLicenseNo != ''">
            and f.carlicenseno = #{carLicenseNo}
        </if>
        <if test="carOwnerName != null  and carOwnerName != ''">
            and d.carownername = #{carOwnerName}
        </if>
        <if test="taskId != null  and taskId != ''">
            and a.taskid = #{taskId}
        </if>
        <if test="policyNo != null  and policyNo != ''">
            and d.policyno = #{policyNo}
        </if>
        <if test="insuredDateBegin != null  and insuredDateBegin != ''">
            and DATE_FORMAT(ifnull(d.insureddate,d.createtime),'%Y-%m-%d') &gt;=  #{insuredDateBegin}
        </if>
        <if test="insuredDateEnd != null  and insuredDateEnd != ''">
            and DATE_FORMAT(ifnull(d.insureddate,d.createtime),'%Y-%m-%d') &lt;= #{insuredDateEnd}
        </if>
        union ALL
        select distinct e.channelname,h.comname,c.inscityname as insuredarea,a.taskid,d.policyno as policyno,f.carlicenseno ,d.carownername
        ,a.providercode as prvid,g.agreementname as compname,ifnull(d.insureddate,d.createtime) as insureddate,d.startdate,'交强险' as risktype,d.premium
        , case when ifnull(ratio.calculatetype,'3') = '1' then b.rate + ifnull(ratio.ratio,0)
        when ifnull(ratio.calculatetype,'3') = '2' then b.rate - ifnull(ratio.ratio,0)
        when ifnull(ratio.calculatetype,'3') = '3' then b.rate * ifnull(ratio.ratio,1)
        else b.rate/ifnull(ratio.ratio,1) end as channelrate
        , case when ifnull(ratio.calculatetype,'3') = '1' then d.premium/ifnull(chnrate.taxrate,1)*(b.rate + ifnull(ratio.ratio,0))
        when ifnull(ratio.calculatetype,'3') = '2' then d.premium/ifnull(chnrate.taxrate,1)*(b.rate - ifnull(ratio.ratio,0))
        when ifnull(ratio.calculatetype,'3') = '3' then d.premium/ifnull(chnrate.taxrate,1)*(b.rate * ifnull(ratio.ratio,1))
        else d.premium/ifnull(chnrate.taxrate,1)*(b.rate/ifnull(ratio.ratio,1)) end  as channelcommission
        ,b.id as commissionruleid,b.remark as commissionremark,b.reminder as commissionreminder
        ,ratio.id as commissionratioid
        ,case when ratio.calculatetype = '1' then '加'
        when ratio.calculatetype = '2' then '减'
        when ratio.calculatetype = '3' then '乘'
        when ratio.calculatetype = '4' then '除'
        else '乘' end as calculatetype
        ,ifnull(ratio.ratio,1) as ratio ,b.rate ,b.rate * d.premium as deptcommission
        ,ifnull(rqrp.inscorpname,rqc.inscorpname) as inscorpname,rqrp.policystarttime,rqrp.policyendtime
        ,rqo.bwcommercialclaimtimes,rqo.firstinsuretype
        ,chnrate.id as taxrateid,ifnull(chnrate.taxrate,1) as taxrate
        from insbcommission a inner JOIN insbcommissionrate b on a.commissionrateid = b.id
        INNER JOIN insbquotetotalinfo c on a.taskid = c.taskid
        INNER JOIN insbpolicyitem d on a.taskid = d.taskid and a.providercode = d.inscomcode
        INNER JOIN insbchannel e on c.purchaserchannel = e.channelinnercode
        INNER JOIN insbcarinfohis f on  a.taskid = f.taskid and a.providercode = f.inscomcode
        INNER JOIN insbagreement g on a.agreementid = g.id
        INNER JOIN inscdept h on  g.deptid = h.id
        LEFT JOIN insbcommissionratio ratio ON a.commissionratioid = ratio.id
        LEFT JOIN insbrulequeryrepeatinsured rqrp on a.taskid = rqrp.taskid and rqrp.risktype = '1'
        LEFT JOIN insbrulequeryotherinfo rqo on a.taskid = rqo.taskid
        LEFT JOIN insbrulequeryclaims rqc on a.taskid = rqc.taskid
        LEFT JOIN insbchntaxrate chnrate on a.channelid = chnrate.channelid and NOW() BETWEEN chnrate.effectivetime and IFNULL(chnrate.terminaltime,'2199-12-31 23:59:59') and chnrate.`status`='1'
        where
        e.childflag = '1'
        AND (
        e.deleteflag != 0
        OR e.deleteflag IS NULL
        )
        and c.purchaserchannel != 'nqd_minizzb2016'
        and a.commissionflag ='insured'
        and a.commissiontype='03'
        and d.risktype='1'
        and d.insuredname not like '%测试%'
        and d.carownername not like '%测试%'
        and d.policyno is not null
        <if test="channelId != null  and channelId != ''">
            and e.channelinnercode = #{channelId}
        </if>
        <if test="prvId != null  and prvId != ''">
            and a.providercode = #{prvId}
        </if>
        <if test="deptId != null  and deptId != ''">
            and g.deptid = #{deptId}
        </if>
        <if test="carLicenseNo != null  and carLicenseNo != ''">
            and f.carlicenseno = #{carLicenseNo}
        </if>
        <if test="carOwnerName != null  and carOwnerName != ''">
            and d.carownername = #{carOwnerName}
        </if>
        <if test="taskId != null  and taskId != ''">
            and a.taskid = #{taskId}
        </if>
        <if test="policyNo != null  and policyNo != ''">
            and d.policyno = #{policyNo}
        </if>
        <if test="insuredDateBegin != null  and insuredDateBegin != ''">
            and DATE_FORMAT(ifnull(d.insureddate,d.createtime),'%Y-%m-%d') &gt;=  #{insuredDateBegin}
        </if>
        <if test="insuredDateEnd != null  and insuredDateEnd != ''">
            and DATE_FORMAT(ifnull(d.insureddate,d.createtime),'%Y-%m-%d') &lt;= #{insuredDateEnd}
        </if>
        ) as a
    </select>

</mapper>