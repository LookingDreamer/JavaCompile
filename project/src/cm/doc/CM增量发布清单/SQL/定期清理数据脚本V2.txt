# 一、先执行以下脚本创建存储过程

#其他数据0
DROP PROCEDURE IF EXISTS `clear_data_by_taskid_other`; 
CREATE PROCEDURE `clear_data_by_taskid_other`(IN max_taskid INT)
BEGIN

		DELETE FROM insbworkflowmain WHERE InstanceId+0<=max_taskid;
		DELETE FROM insbworkflowmaintrack WHERE InstanceId+0<=max_taskid;
		DELETE FROM insbworkflowsub WHERE maininstanceid+0<=max_taskid;
		DELETE FROM insbworkflowsubtrack WHERE maininstanceid+0<=max_taskid;
		
END;


#其他数据1
DROP PROCEDURE IF EXISTS `clear_data_by_taskid_vorder`; 
CREATE PROCEDURE `clear_data_by_taskid_vorder`(IN max_taskid INT)
BEGIN
		
		DELETE FROM insborder WHERE taskid+0<=max_taskid;
		DELETE FROM insborderdelivery WHERE taskid+0<=max_taskid;
		DELETE FROM insborderexceptions WHERE taskid+0<=max_taskid;
		DELETE FROM insborderpayment WHERE taskid+0<=max_taskid;
		DELETE FROM insblegalrightclaim WHERE taskid+0<=max_taskid;
		DELETE FROM insbrelationperson WHERE taskid+0<=max_taskid;
		DELETE FROM insbrealtimetask WHERE maininstanceid+0<=max_taskid;
		
END;


#其他数据2
DROP PROCEDURE IF EXISTS `clear_data_by_taskid_vhis`; 
CREATE PROCEDURE `clear_data_by_taskid_vhis`(IN max_taskid INT)
BEGIN
		
		DELETE FROM insbcarinfohis WHERE taskid+0<=max_taskid;
		DELETE FROM insbinsuredhis WHERE taskid+0<=max_taskid;
		DELETE FROM insbapplicanthis WHERE taskid+0<=max_taskid;
		DELETE FROM insblegalrightclaimhis WHERE taskid+0<=max_taskid;
		DELETE FROM insbrelationpersonhis WHERE taskid+0<=max_taskid;
		
		DELETE FROM inshcarinfohis WHERE taskid+0<=max_taskid;
		DELETE FROM inshcarkindprice WHERE taskid+0<=max_taskid;
		DELETE FROM inshapplicanthis WHERE taskid+0<=max_taskid;
		DELETE FROM inshcarowneinfo WHERE taskid+0<=max_taskid;
		DELETE FROM inshinsuredhis WHERE taskid+0<=max_taskid;
		DELETE FROM inshlegalrightclaimhis WHERE taskid+0<=max_taskid;
		DELETE FROM inshorder WHERE taskid+0<=max_taskid;
		DELETE FROM inshorderdelivery WHERE taskid+0<=max_taskid;
		DELETE FROM inshorderpayment WHERE taskid+0<=max_taskid;
		DELETE FROM inshperson WHERE taskid+0<=max_taskid;
		DELETE FROM inshperson_new WHERE taskid+0<=max_taskid;
		DELETE FROM inshpolicyitem WHERE taskid+0<=max_taskid;
		DELETE FROM inshquotetotalinfo WHERE taskid+0<=max_taskid;
		DELETE FROM inshrelationpersonhis WHERE taskid+0<=max_taskid;
		DELETE FROM inshspecifydriverhis WHERE taskid+0<=max_taskid;

END;


#其他数据3
DROP PROCEDURE IF EXISTS `clear_data_by_taskid_v_carinfoid`; 
CREATE PROCEDURE `clear_data_by_taskid_v_carinfoid`(IN max_taskid INT)
BEGIN

		DELETE a FROM insbquoteinfo a INNER JOIN insbquotetotalinfo b on a.quotetotalinfoid=b.id WHERE b.taskid+0<=max_taskid;
		DELETE a FROM inshquoteinfo a INNER JOIN insbquotetotalinfo b on a.quotetotalinfoid=b.id WHERE b.taskid+0<=max_taskid;
		
		DELETE a FROM insbcarmodelinfo a INNER JOIN insbcarinfo b on a.carinfoid=b.id WHERE b.taskid+0<=max_taskid;
		DELETE a FROM insbcarmodelinfohis a INNER JOIN insbcarinfo b on a.carinfoid=b.id WHERE b.taskid+0<=max_taskid;
		DELETE a FROM inshcarmodelinfohis a INNER JOIN insbcarinfo b on a.carinfoid=b.id WHERE b.taskid+0<=max_taskid;

		DELETE FROM insbcarconfig WHERE taskid+0<=max_taskid;
		DELETE FROM insbcarkindprice WHERE taskid+0<=max_taskid;
		
		DELETE FROM insbpolicyitem WHERE taskid+0<=max_taskid;
		DELETE FROM insbperson WHERE taskid+0<=max_taskid;
		DELETE FROM insbinsured WHERE taskid+0<=max_taskid;
		DELETE FROM insbapplicant WHERE taskid+0<=max_taskid;
		DELETE FROM insbcarowneinfo WHERE taskid+0<=max_taskid;

END;


#其他数据4
DROP PROCEDURE IF EXISTS `clear_data_by_taskid_logs`; 
CREATE PROCEDURE `clear_data_by_taskid_logs`(IN max_taskid INT)
BEGIN

		DELETE FROM insbsupplement WHERE taskid+0<=max_taskid;
		DELETE FROM insbmonitor WHERE taskid+0<=max_taskid;
		DELETE FROM insbflowlogs WHERE taskid+0<=max_taskid;

END;


#工作流数据
DROP PROCEDURE IF EXISTS `clear_data_by_taskid_wf`; 
CREATE PROCEDURE `clear_data_by_taskid_wf`(IN max_taskid INT)
BEGIN

		DELETE a FROM content a INNER JOIN task b on a.id=b.documentContentId WHERE b.processInstanceId+0<=max_taskid;
		DELETE a FROM content a INNER JOIN task b on a.id=b.outputContentId WHERE b.processInstanceId+0<=max_taskid;
		DELETE a FROM sessioninfo a INNER JOIN task b on a.id=b.processSessionId WHERE b.processInstanceId+0<=max_taskid;
		DELETE a FROM workiteminfo a INNER JOIN task b on a.workItemId=b.workItemId WHERE b.processInstanceId+0<=max_taskid;
				
		DELETE FROM nodeinstancelog WHERE processInstanceId+0<=max_taskid;
		DELETE FROM variableinstancelog WHERE processInstanceId+0<=max_taskid;
		DELETE FROM processinstancelog WHERE processInstanceId+0<=max_taskid;
		DELETE FROM processinstanceinfo WHERE InstanceId+0<=max_taskid;
		DELETE FROM i18ntext WHERE (Task_Subjects_Id is not null and Task_Subjects_Id!='' and Task_Subjects_Id+0<=max_taskid) or (Task_Names_Id is not null and Task_Names_Id!='' and Task_Names_Id+0<=max_taskid) or (Task_Descriptions_Id is not null and Task_Descriptions_Id!='' and Task_Descriptions_Id+0<=max_taskid);
		DELETE FROM task WHERE processInstanceId+0<=max_taskid;

END;


#主查询数据
DROP PROCEDURE IF EXISTS `clear_data_by_taskid_main`; 
CREATE PROCEDURE `clear_data_by_taskid_main`(IN max_taskid INT)
BEGIN

		DELETE FROM insbworkflowmaintrackdetail WHERE InstanceId+0<=max_taskid;
		DELETE FROM insbworkflowsubtrackdetail WHERE maininstanceid+0<=max_taskid;
		DELETE FROM insbcarinfo WHERE taskid+0<=max_taskid;
		DELETE FROM insbquotetotalinfo WHERE taskid+0<=max_taskid;

END;



# 二、按顺序执行以下脚本调用存储过程，将任务号小于等于传入参数的数据都清除，参数是整数，不用加引号
# 注意！！！以下示例中的参数 7081495 是生产环境 2016年11月份 之前最大的任务号，表示将 2016年11月份 之前的数据清除。
# ！！！测试环境需要另外查询出需要清除数据的任务号，不要使用这个默认值！！！
CALL clear_data_by_taskid_other(7081495);
CALL clear_data_by_taskid_vorder(7081495);
CALL clear_data_by_taskid_vhis(7081495);
CALL clear_data_by_taskid_v_carinfoid(7081495);
CALL clear_data_by_taskid_logs(7081495);

SET foreign_key_checks = 0;
CALL clear_data_by_taskid_wf(7081495);
SET foreign_key_checks = 1;

# 最后执行以下存储过程
CALL clear_data_by_taskid_main(7081495);