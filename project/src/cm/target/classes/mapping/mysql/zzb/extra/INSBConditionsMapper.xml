<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zzb.extra.entity">
    <!-- INSBConditions -->
    <select id="INSBConditions_insert" parameterType="com.zzb.extra.entity.INSBConditions" resultType="int">
		insert into INSBConditions
		(id,operator,createtime,modifytime,noti,sourceid,conditionsource,paramdatatype,paramname,expression,paramvalue)
		values
		(#{id},#{operator},#{createtime},#{modifytime},#{noti},#{sourceid},#{conditionsource},#{paramdatatype},#{paramname},#{expression},#{paramvalue})
	</select>
    <select id="queryConditionsList" parameterType="Map" resultType="Map">
       	select c.id,c.sourceid,c.conditionsource,c.paramdatatype,c.paramname,p.paramcnname,c.expression,c.paramvalue,
        DATE_FORMAT(c.createtime,'%Y-%m-%d %H:%i:%s') AS createtime
        from INSBConditions c
        LEFT JOIN INSBConditionParams p ON p.paramname=c.paramname
        <where>
            <if test="sourceid != null">
                and c.sourceid = #{sourceid}
            </if>
            <if test="conditionsource != null">
                and c.conditionsource = #{conditionsource}
            </if>
            <if test="paramname != null">
                and c.paramname = #{paramname}
            </if>
            <if test="expression != null">
                and c.expression = #{expression}
            </if>
            <if test="paramvalue != null">
                and c.paramvalue = #{paramvalue}
            </if>
        </where>
        ORDER BY
        <if test="sort != null and order != null">
            ${sort} ${order}
        </if>
        <if test="sort == null">
            c.createtime desc,c.id
        </if>
        <if test="offset != null and limit != null">
            LIMIT #{offset},#{limit}
        </if>
    </select>
    <select id="INSBConditions_containsParam" parameterType="String" resultType="int">
       	select count(1) from INSBConditions where paramname = #{paramname}
    </select>
    <select id="INSBConditions_selectById" parameterType="String" resultType="com.zzb.extra.entity.INSBConditions">
		select * from INSBConditions where id = #{id}
	</select>
    <select id="INSBConditions_deleteById" parameterType="String">
		delete from INSBConditions where id = #{id}
	</select>
    <select id="INSBConditions_deleteBySourceId" parameterType="String">
        delete from INSBConditions where sourceid = #{sourceid}
    </select>
    <select id="INSBConditions_updateById" parameterType="com.zzb.extra.entity.INSBConditions" resultType="int">
		update INSBConditions  set operator = #{operator},modifytime = #{modifytime},paramdatatype = #{paramdatatype},paramname = #{paramname},expression = #{expression},paramvalue = #{paramvalue} where id = #{id}
	</select>
    <select id="queryConditionsListCount" parameterType="Map" resultType="Long">
       	select count(1) from INSBConditions
        <where>
            <if test="sourceid != null">
                and sourceid = #{sourceid}
            </if>
            <if test="conditionsource != null">
                and conditionsource = #{conditionsource}
            </if>
            <if test="paramname != null">
                and paramname = #{paramname}
            </if>
            <if test="expression != null">
                and expression = #{expression}
            </if>
            <if test="paramvalue != null">
                and paramvalue = #{paramvalue}
            </if>
        </where>
    </select>
    <select id="INSBConditions_selectOne" parameterType="Map" resultType="com.zzb.extra.entity.INSBConditions">
       	select * from INSBConditions
        <where>
            <if test="sourceid != null">
                and sourceid = #{sourceid}
            </if>
            <if test="conditionsource != null">
                and conditionsource = #{conditionsource}
            </if>
            <if test="paramname != null">
                and paramname = #{paramname}
            </if>
            <if test="expression != null">
                and expression = #{expression}
            </if>
            <if test="paramvalue != null">
                and paramvalue = #{paramvalue}
            </if>
        </where>
        LIMIT 2
    </select>
    <select id="queryConditions" parameterType="Map" resultType="com.zzb.extra.entity.INSBConditions">
       	select * from INSBConditions
        <where>
            <if test="sourceid != null and sourceid != ''">
                and sourceid = #{sourceid}
            </if>
            <if test="conditionsource != null and conditionsource != ''">
                and conditionsource = #{conditionsource}
            </if>
        </where>
        ORDER BY paramname,expression,paramvalue
    </select>
    <select id="INSBConditions_selectCount" parameterType="com.zzb.extra.entity.INSBConditions" resultType="Long">
       	select count(1) from INSBConditions
        <where>
            <if test="sourceid != null">
                and sourceid = #{sourceid}
            </if>
            <if test="conditionsource != null">
                and conditionsource = #{conditionsource}
            </if>
            <if test="paramname != null">
                and paramname = #{paramname}
            </if>
            <if test="expression != null">
                and expression = #{expression}
            </if>
            <if test="paramvalue != null">
                and paramvalue = #{paramvalue}
            </if>
        </where>
    </select>
    <select id="queryAgreementIdByTask" parameterType="com.zzb.extra.model.AgentTaskModel" resultType="String">
       	select q.agreementid FROM insbquotetotalinfo t
        LEFT JOIN insbquoteinfo q ON q.quotetotalinfoid=t.id
        WHERE t.taskid=#{taskid} AND q.inscomcode=#{providercode}
        LIMIT 1
    </select>
    <select id="queryDeptCodeByTask" parameterType="com.zzb.extra.model.AgentTaskModel" resultType="String">
        select q.deptcode FROM insbquotetotalinfo t
        LEFT JOIN insbquoteinfo q ON q.quotetotalinfoid=t.id
        WHERE t.taskid=#{taskid} AND q.inscomcode=#{providercode}
        LIMIT 1
    </select>
    <select id="queryParamsByTask" parameterType="com.zzb.extra.model.AgentTaskModel" resultType="Map">
       	select c.carlicenseno as carLicenseNumber,p.inscomcode as providerCode,q.inscitycode as insureCityCode,c.carproperty as carUseProps,
        CASE WHEN TO_DAYS(NOW()) - TO_DAYS(IFNULL(c.registdate,NOW())) &lt;= 270 then '1' ELSE '0' END  as isNewCar, IFNULL(c.istransfercar,'0') as isTransferCar,
        IFNULL(cm.standardfullname,'') as carModelName,IFNULL(cm.brandname,'') AS brandName,
        IFNULL(cm.familyname,'') as familyName,IFNULL(cm.seat,5) as seat,
        IFNULL(c.carVehicularApplications,0) as carVehicularApplications,
        IFNULL(c.property,'0') as property,
        IFNULL(cm.unwrtweight,0) as unwrtWeight,
        IFNULL(cm.displacement,0) as displacement,
        IFNULL(c.taxprice,0) as taxPrice,
        (TO_DAYS(IFNULL(p1.insureddate,p1.createtime)) - TO_DAYS(IFNULL(c.registdate,NOW()))) as vehicleAge ,
        date_format(p1.startDate,'%Y%m%d') as startDate,
        c.ownername as ownerName,
        k.amount as VehicleDemageInsAmount,
        IFNULL(cm.carVehicleOrigin,'') as carVehicleOrigin,
        IFNULL(p1.discountrate,-1) as commercialDiscountRate,
        IFNULL(p2.discountrate,-1) as compulsoryDiscountRate,
		cm.price as carPrice,REPLACE(FORMAT(p.totalepremium,2),',','') AS totalPremium,
        REPLACE(FORMAT(IFNULL(p1.discountCharge,0.0),2),',','') AS commercialPremium,
        REPLACE(FORMAT(IFNULL(p2.discountCharge,0.0),2),',','') AS compulsoryPremium FROM insbpolicyitem p
        LEFT JOIN insbpolicyitem p1 ON p1.taskid=p.taskid and p1.inscomcode=p.inscomcode and p1.risktype=0
        LEFT JOIN insbpolicyitem p2 ON p2.taskid=p.taskid and p2.inscomcode=p.inscomcode and p2.risktype=1
        LEFT JOIN insbcarinfo c ON c.id=p.carinfoid
        LEFT JOIN insbcarmodelinfo cm ON cm.carinfoid=c.id
	    LEFT JOIN insbcarmodelinfo m ON m.carinfoid=c.id
		LEFT JOIN insbquotetotalinfo q ON q.taskid=p.taskid
		LEFT JOIN insbcarkindprice k ON k.taskid = p1.taskid and k.inscomcode = p1.inscomcode and k.inskindcode='VehicleDemageIns'
        WHERE p.taskid=#{taskid} AND p.inscomcode=#{providercode}
        LIMIT 1
    </select>
    <select id="queryTotalCommercialPolicyCount" parameterType="com.zzb.extra.model.AgentTaskModel" resultType="Map">
       	select count(1) as counts FROM insbpolicyitem p
		LEFT JOIN insbagenttask t ON t.taskid=p.taskid
        WHERE p.risktype='0' and p.policystatus='1' and t.agentid=#{agentid}
    </select>
    <select id="queryActiveCommercialPolicyCount" parameterType="com.zzb.extra.model.AgentTaskModel" resultType="Map">
       	select count(1) as counts FROM insbpolicyitem p
        LEFT JOIN insbagenttask t ON t.taskid=p.taskid
        <where>
            p.risktype='0' and p.policystatus='1' and t.agentid=#{agentid}
            <if test="startdate != null and enddate != null">
                AND date_format(p.createtime,'%Y-%m-%d') &gt;= date_format(#{startdate},'%Y-%m-%d')
                AND date_format(p.createtime,'%Y-%m-%d') &lt; date_format(#{enddate},'%Y-%m-%d')
            </if>
        </where>
    </select>
    <select id="queryInsureType" parameterType="com.zzb.extra.model.AgentTaskModel" resultType="Map">
       	select GROUP_CONCAT(risktype) as insuretype FROM insbpolicyitem
        WHERE taskid=#{taskid} and inscomcode=#{providercode}
    </select>
    <select id="queryRegistrationCount" parameterType="com.zzb.extra.model.AgentTaskModel" resultType="Map">
       	select count(1) as counts FROM insbagent
        WHERE usersource='minizzb' and referrerid=#{agentid}
    </select>
    <select id="queryCoverage" parameterType="Map" resultType="Double">
       	select IFNULL(amount,0.0) AS coverage FROM insbcarkindprice
        WHERE inskindcode=#{inskindcode} and taskid=#{taskid} and inscomcode=#{providercode}
    </select>
    <select id="queryLastInsertInfo1" parameterType="com.zzb.extra.model.AgentTaskModel" resultType="Map">
       	SELECT IFNULL(claimtimes,-1) as commercialClaimTimes,IFNULL(a.compulsoryClaimTimes,-1) as compulsoryClaimTimes ,
       	 bwcommercialclaimrate as commercialClaimRate,firstinsuretype as firstInsureType
        FROM insbrulequeryotherinfo a
        where a.taskid = #{taskid}
        LIMIT 1
    </select>
    <select id="queryLastInsertInfo2" parameterType="com.zzb.extra.model.AgentTaskModel" resultType="Map">
         SELECT lastInsureCo FROM (
         SELECT
         IFNULL(b.inscorpcode,'0') AS lastInsureCo,b.risktype
         FROM insbrulequeryclaims AS  b
         WHERE b.taskid =  #{taskid}
        UNION ALL
         SELECT
         IFNULL(a.inscorpcode,'0') AS lastInsureCo,a.risktype
         FROM insbrulequeryrepeatinsured AS a
         WHERE a.taskid =  #{taskid}
         )  AS c
        ORDER  by c.risktype ASC,lastInsureCo DESC
        LIMIT 1
    </select>
</mapper>