<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zzb.extra.entity">
    <!-- INSBAgentTask //任务99关联的mini营销活动代码发布cm后台-->
    <select id="INSBAgentTask_insert" parameterType="com.zzb.extra.entity.INSBAgentTask" resultType="int">
		insert into INSBAgentTask
		(id,operator,createtime,modifytime,noti,agentid,taskid,status)
		values
		(#{id},#{operator},#{createtime},#{modifytime},#{noti},#{agentid},#{taskid},#{status})
	</select>
    <select id="INSBAgentTask_select" parameterType="Map" resultType="com.zzb.extra.entity.INSBAgentTask">
       	select * from INSBAgentTask
        <where>
            <if test="agentid != null">
                and agentid = #{agentid}
            </if>
            <if test="taskid != null">
                and taskid = #{taskid}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
        </where>
    </select>
    <select id="INSBAgentTask_selectOne" parameterType="com.zzb.extra.entity.INSBAgentTask" resultType="com.zzb.extra.entity.INSBAgentTask">
        select * from INSBAgentTask
        <where>
            <if test="agentid != null">
                and agentid = #{agentid}
            </if>
            <if test="taskid != null">
                and taskid = #{taskid}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
        </where>
    </select>
    <select id="INSBAgentTask_selectById" parameterType="String" resultType="com.zzb.extra.entity.INSBAgentTask">
		select * from INSBAgentTask where id = #{id}
	</select>
    <select id="INSBAgentTask_deleteById" parameterType="String">
		delete from INSBAgentTask where id = #{id}
	</select>
    <select id="INSBAgentTask_updateById" parameterType="com.zzb.extra.entity.INSBAgentTask">
		update INSBAgentTask  set operator = #{operator},modifytime = #{modifytime},noti = #{noti},agentid = #{agentid},taskid = #{taskid},status = #{status} where id = #{id}
	</select>
    <select id="INSBAgentTask_completeByTaskId" parameterType="String" resultType="int">
        update INSBAgentTask  set modifytime = NOW(),status ='1' where taskid = #{taskid} and status='0'
    </select>
    <select id="INSBAgentTask_selectCount" parameterType="Map" resultType="Long">
       	select count(1) from INSBAgentTask
        <where>
            <if test="agentid != null">
                and agentid = #{agentid}
            </if>
            <if test="taskid != null">
                and taskid = #{taskid}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
        </where>
    </select>
    <select id="queryAgentTaskByPolicyNo" parameterType="Map" resultType="com.zzb.extra.entity.INSBAgentTask">
		select a.* from INSBAgentTask a
		 LEFT JOIN INSBPolicyItem p ON a.taskid=p.taskid
		 where a.agentid=#{agentid} AND p.policyno = #{policyno} AND p.policystatus='1' AND a.status='0'
		LIMIT 1
	</select>

    <select id="queryAgentTasks" resultType="com.zzb.extra.model.AgentTaskModel">
       	select DISTINCT t.agentid,t.taskid,p.inscomcode as providercode,q.agreementid,a.referrerid FROM INSBAgentTask t
        LEFT JOIN insbagent a ON a.id=t.agentid
        LEFT JOIN insbpolicyitem p ON p.taskid=t.taskid
        LEFT JOIN insbquotetotalinfo qt ON p.taskid=qt.taskid
        LEFT JOIN insbquoteinfo q ON q.quotetotalinfoid=qt.id AND q.inscomcode=p.inscomcode
        WHERE t.status='0' AND p.policystatus='1'
    </select>

    <select id="queryCompletedTaskByTaskId" parameterType="Map" resultType="com.zzb.extra.model.AgentTaskModel">
       	select DISTINCT t.agentid,t.taskid,p.inscomcode as providercode,q.agreementid,a.referrerid FROM INSBAgentTask t
        LEFT JOIN insbagent a ON a.id=t.agentid
        LEFT JOIN insbpolicyitem p ON p.taskid=t.taskid
        LEFT JOIN insbquotetotalinfo qt ON p.taskid=qt.taskid
        LEFT JOIN insbquoteinfo q ON q.quotetotalinfoid=qt.id AND q.inscomcode=p.inscomcode
        <where>
            <if test="taskid != null  and taskid != ''">
                and t.taskid = #{taskid}
            </if>
            <if test="providercode != null and providercode != ''">
                and p.inscomcode = #{providercode}
            </if>
           and t.status='0'
        </where>
    </select>
    <select id="selectNameByTaskid" parameterType="String" resultType="Map">
    	select a.name,a.phone from insbagenttask t,insbagent a where t.taskid = #{taskid} and t.agentid = a.id and a.usersource='minizzb'
    </select>
    <select id="selectIdByName" parameterType="Map" resultType="Map">
    	select id from INSBAgent 
    	<where>
    		<if test="name != null and name !='' ">
    			and name = #{name}
    		</if>
    		<if test="phone != null and phone !='' ">
    			and phone = #{phone}
    		</if>
    			and usersource='minizzb'
    	</where> 
    </select>
    <!--refresh-->
</mapper>